基于AngularJS构建单页应用
====

单页应用

大型单页应用要做的第一件事就是分层架构。

分层架构有利于把职责清晰化，每块可以单独做测试。

数据模型层必须独立出来，所以有些Angular文章推荐给所有service建一个module，然后把一切包含数据模型的service都放进去。可以这么做，也可以再细分。

分层做完，就要考虑懒加载的问题了。

我们看看一个典型的场景，一个工作台，或者说门户界面，上面能够放很多小部件，类似iGoogle那样，用户可以任意加已有的部件，这些部件都是基于某种约定，由第三方开发人员完成。这种如果在单页应用里，该怎么实现呢？

先来看部件有些什么可以做的事。他可以有界面，有逻辑，有样式。这些都可以分别动态加载出来，比如HTML片段可以ng-include或者$get过来append，js文件可以require，css可以行间也可以动态加rule，因为这些部件是要跟我们主界面在同一个页面作用域内，所以要尽量营造隔离的环境。

HTML好办，它直接拿来放在某容器里就可以了，互相影响不到。JavaScript的话，最基本的就是避免全局变量，在Angular体系中，还需要作些特殊的考虑。我们知道，Angular里面，第一级组织单元是module，但它这个module的概念跟AMD那种module的不同，如果说AMD的module相当于Java Class的级别，Angular的要相当于package了。

这就有了我们的第一个问题：部件里面的JavaScript代码跟主界面的在不在一个module内？如果是别的框架，这不是个问题，但这货是angular，有些纠结，这里面还分两种情况：

- 部件很独立，相互无任何协作关系
- 部件之间有协作，包括可能共享代码或者有通信

第一种很好办，我们可以让这个部件自己定义ng-app，这样它就是一个独立隔离的环境了。

第二种很麻烦，因为Angular的module依赖关系想要动态加很复杂，所以我们只能约定已有的module，然后让部件的js从这个module上加自己的代码。

CSS的隔离也比较麻烦，因为样式是全局生效的，我们必须约定某种规则，让第三方开发者的样式只能挂在他这个部件下，无论是行间样式还是引入的外部样式，都不能起到这个限制的作用。所以，必须使用更苛刻的手段。

思路肯定是要从某种元素往下写的，我们给他一个特定元素，他以这个为基准，所有自己的CSS都定义在这个元素的选择符之下。那么，这些不同的部件之间，又要如何区分呢？

想想，部件之间其实只有很少东西能用于区分，比如说全局唯一的部件名，所以，我们以此为依据，这样来约定：

- 在主界面中包含部件的容器，生成一个如下的元素：

    <div data-appname="sampleApp"></div>

真实的部件HTML代码会被放置在其中，举例来说，这个部件的HTML是：

    <ul>
        <li>Apple</li>
        <li>Pear</li>
    </ul>

它的CSS就可以这么写：

    div[data-appname="sampleApp"] ul {
    
    }